<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TensorBoard ÂèØËßÜÂåñ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }
        .card:hover {
            box-shadow: 0 14px 28px rgba(0,0,0,0.12), 0 10px 10px rgba(0,0,0,0.1);
        }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .slider-thumb::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .chart-container {
            position: relative;
            height: 280px;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid #667eea;
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div x-data="app()" x-init="init()">
        <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
        <nav class="gradient-bg text-white shadow-lg sticky top-0 z-50">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <div>
                            <h1 class="text-2xl font-bold">TensorBoard ÂèØËßÜÂåñ</h1>
                            <p class="text-sm text-white/80">ËÆ≠ÁªÉÊó•ÂøóÂàÜÊûê‰∏éÂ±ïÁ§∫</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="bg-white/20 px-3 py-1 rounded-full text-sm">ÁâàÊú¨: {{ file_version }}</span>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Ê†áÁ≠æÈ°µÂØºËà™ -->
        <div class="bg-white border-b sticky top-[72px] z-40 shadow-sm">
            <div class="container mx-auto px-6">
                <div class="flex space-x-8">
                    <button @click="currentTab = 'scalars'" 
                            :class="currentTab === 'scalars' ? 'border-b-4 border-indigo-600 text-indigo-600' : 'text-gray-600 hover:text-gray-800'"
                            class="py-4 font-semibold transition-colors">
                        üìä Ê†áÈáèÊï∞ÊçÆ (<span x-text="scalarTags.length"></span>)
                    </button>
                    <button @click="currentTab = 'images'" 
                            :class="currentTab === 'images' ? 'border-b-4 border-indigo-600 text-indigo-600' : 'text-gray-600 hover:text-gray-800'"
                            class="py-4 font-semibold transition-colors">
                        üñºÔ∏è ÂõæÂÉè (<span x-text="imageTags.length"></span>)
                    </button>
                    <button @click="currentTab = 'audio'" 
                            :class="currentTab === 'audio' ? 'border-b-4 border-indigo-600 text-indigo-600' : 'text-gray-600 hover:text-gray-800'"
                            class="py-4 font-semibold transition-colors">
                        üîä Èü≥È¢ë (<span x-text="audioTags.length"></span>)
                    </button>
                </div>
            </div>
        </div>

        <div class="container mx-auto px-6 py-8">
            <!-- Ê†áÈáèÊï∞ÊçÆÊ†áÁ≠æÈ°µ -->
            <div x-show="currentTab === 'scalars'" 
                 x-transition>
                <div class="mb-8">
                    <h2 class="section-title">üìä Ê†áÈáèÊï∞ÊçÆ</h2>
                </div>
                
                <!-- Ê†áÈáèÂõæË°®ÁΩëÊ†º -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <template x-for="(tag, index) in scalarTags" :key="tag">
                        <div class="card p-6" 
                             x-data="{ chartInstance: null }"
                             x-init="
                                 const renderChart = () => {
                                     if (!scalarsLoaded) {
                                         setTimeout(renderChart, 100);
                                         return;
                                     }
                                     const data = scalarData[tag];
                                     if (!data || !data.steps || data.steps.length === 0) {
                                         console.warn('No data for tag:', tag);
                                         return;
                                     }
                                     const canvas = $el.querySelector('canvas');
                                     if (!canvas) return;
                                     chartInstance = new Chart(canvas, {
                                         type: 'line',
                                         data: {
                                             labels: data.steps,
                                             datasets: [{
                                                 label: tag,
                                                 data: data.values,
                                                 borderColor: 'rgb(102, 126, 234)',
                                                 backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                                 tension: 0.4,
                                                 pointRadius: 0,
                                                 borderWidth: 2
                                             }]
                                         },
                                         options: {
                                             responsive: true,
                                             maintainAspectRatio: false,
                                             plugins: {
                                                 legend: { display: false },
                                                 tooltip: { mode: 'index', intersect: false }
                                             },
                                             scales: {
                                                 x: {
                                                     title: { display: true, text: 'Step', font: { size: 11 } },
                                                     grid: { color: 'rgba(0, 0, 0, 0.05)' },
                                                     ticks: { font: { size: 10 } }
                                                 },
                                                 y: {
                                                     title: { display: true, text: 'Value', font: { size: 11 } },
                                                     grid: { color: 'rgba(0, 0, 0, 0.05)' },
                                                     ticks: { font: { size: 10 } }
                                                 }
                                             }
                                         }
                                     });
                                 };
                                 renderChart();
                             ">
                            <div class="mb-4">
                                <h3 class="font-semibold text-gray-800 text-sm mb-1" x-text="tag"></h3>
                                <div class="text-xs text-gray-500" x-show="scalarData[tag]">
                                    <span x-text="scalarData[tag]?.steps?.length || 0"></span> ‰∏™Êï∞ÊçÆÁÇπ
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas></canvas>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- ÂõæÂÉèÊ†áÁ≠æÈ°µ -->
            <div x-show="currentTab === 'images'" x-transition>
                <div class="mb-8">
                    <h2 class="section-title">üñºÔ∏è ÂõæÂÉèÊï∞ÊçÆ</h2>
                </div>

                <!-- ÂõæÂÉèÁΩëÊ†º -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <template x-for="tag in imageTags" :key="tag">
                        <div class="card p-6">
                            <div class="mb-4">
                                <h3 class="font-semibold text-gray-800 mb-2" x-text="tag"></h3>
                                
                                <!-- Step Slider -->
                                <div class="mb-4" x-show="imageData[tag]">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="text-xs font-medium text-gray-600">ËÆ≠ÁªÉÊ≠•Êï∞</label>
                                        <span class="text-xs font-bold text-indigo-600" 
                                              x-text="'Step: ' + (imageData[tag]?.[imageIndices[tag]]?.step || 0)"></span>
                                    </div>
                                    <input type="range" 
                                           x-model="imageIndices[tag]"
                                           :min="0" 
                                           :max="(imageData[tag]?.length || 1) - 1"
                                           class="slider-thumb w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                                        <span>0</span>
                                        <span x-text="(imageData[tag]?.length || 1) - 1"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- ÂõæÂÉè -->
                            <div class="bg-gray-100 rounded-lg overflow-hidden min-h-[200px] flex items-center justify-center">
                                <img :src="imageData[tag]?.[imageIndices[tag]]?.data" 
                                     :alt="'Step ' + imageData[tag]?.[imageIndices[tag]]?.step"
                                     class="max-w-full h-auto"
                                     x-show="imageData[tag]?.[imageIndices[tag]]">
                            </div>

                            <!-- ÂõæÂÉè‰ø°ÊÅØ -->
                            <div class="mt-3 grid grid-cols-3 gap-2 text-xs" x-show="imageData[tag]?.[imageIndices[tag]]">
                                <div class="bg-gray-50 p-2 rounded text-center">
                                    <div class="text-gray-500">ÂÆΩÂ∫¶</div>
                                    <div class="font-semibold" x-text="imageData[tag]?.[imageIndices[tag]]?.width + 'px'"></div>
                                </div>
                                <div class="bg-gray-50 p-2 rounded text-center">
                                    <div class="text-gray-500">È´òÂ∫¶</div>
                                    <div class="font-semibold" x-text="imageData[tag]?.[imageIndices[tag]]?.height + 'px'"></div>
                                </div>
                                <div class="bg-gray-50 p-2 rounded text-center">
                                    <div class="text-gray-500">Á¥¢Âºï</div>
                                    <div class="font-semibold" x-text="(parseInt(imageIndices[tag]) + 1) + '/' + (imageData[tag]?.length || 0)"></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Èü≥È¢ëÊ†áÁ≠æÈ°µ -->
            <div x-show="currentTab === 'audio'" x-transition>
                <div class="mb-8">
                    <h2 class="section-title">üîä Èü≥È¢ëÊï∞ÊçÆ</h2>
                </div>

                <!-- Èü≥È¢ëÁΩëÊ†º -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <template x-for="tag in audioTags" :key="tag">
                        <div class="card p-6">
                            <div class="mb-4">
                                <h3 class="font-semibold text-gray-800 mb-2" x-text="tag"></h3>
                                
                                <!-- Step Slider -->
                                <div class="mb-4" x-show="audioData[tag]">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="text-xs font-medium text-gray-600">ËÆ≠ÁªÉÊ≠•Êï∞</label>
                                        <span class="text-xs font-bold text-indigo-600" 
                                              x-text="'Step: ' + (audioData[tag]?.[audioIndices[tag]]?.step || 0)"></span>
                                    </div>
                                    <input type="range" 
                                           x-model="audioIndices[tag]"
                                           :min="0" 
                                           :max="(audioData[tag]?.length || 1) - 1"
                                           class="slider-thumb w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                                        <span>0</span>
                                        <span x-text="(audioData[tag]?.length || 1) - 1"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Èü≥È¢ëÊí≠ÊîæÂô® -->
                            <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-5 mb-3 shadow-sm border border-gray-200">
                                <audio controls 
                                       controlslist="nodownload"
                                       :src="audioData[tag]?.[audioIndices[tag]]?.data"
                                       class="w-full mb-3"
                                       style="filter: saturate(0.8) hue-rotate(230deg);"
                                       x-show="audioData[tag]?.[audioIndices[tag]]">
                                </audio>
                                <a :href="audioData[tag]?.[audioIndices[tag]]?.data"
                                   :download="tag.replace(/\//g, '_') + '_' + (audioData[tag]?.[audioIndices[tag]]?.step || 0) + '.wav'"
                                   class="group relative w-full inline-flex items-center justify-center px-5 py-2.5 bg-white hover:bg-gray-50 border-2 border-indigo-200 hover:border-indigo-400 text-indigo-700 text-sm font-semibold rounded-lg transition-all duration-200 shadow-sm hover:shadow-md"
                                   x-show="audioData[tag]?.[audioIndices[tag]]">
                                    <svg class="w-4 h-4 mr-2 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                    </svg>
                                    <span class="group-hover:translate-x-0.5 transition-transform">‰∏ãËΩΩÈü≥È¢ëÊñá‰ª∂</span>
                                </a>
                            </div>

                            <!-- Èü≥È¢ë‰ø°ÊÅØ -->
                            <div class="grid grid-cols-3 gap-2 text-xs" x-show="audioData[tag]?.[audioIndices[tag]]">
                                <div class="bg-gray-50 p-2 rounded text-center">
                                    <div class="text-gray-500">ÈááÊ†∑Áéá</div>
                                    <div class="font-semibold" x-text="Math.round(audioData[tag]?.[audioIndices[tag]]?.sample_rate) + ' Hz'"></div>
                                </div>
                                <div class="bg-gray-50 p-2 rounded text-center">
                                    <div class="text-gray-500">Â∏ßÊï∞</div>
                                    <div class="font-semibold" x-text="audioData[tag]?.[audioIndices[tag]]?.length_frames"></div>
                                </div>
                                <div class="bg-gray-50 p-2 rounded text-center">
                                    <div class="text-gray-500">Á¥¢Âºï</div>
                                    <div class="font-semibold" x-text="(parseInt(audioIndices[tag]) + 1) + '/' + (audioData[tag]?.length || 0)"></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Loading ÊèêÁ§∫ -->
        <div x-show="loading" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 shadow-2xl">
                <div class="flex items-center space-x-3">
                    <svg class="animate-spin h-6 w-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-gray-700 font-medium">Âä†ËΩΩ‰∏≠...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                currentTab: 'scalars',
                scalarTags: {{ scalar_tags | tojson }},
                imageTags: {{ image_tags | tojson }},
                audioTags: {{ audio_tags | tojson }},
                
                scalarData: {},
                scalarsLoaded: false,
                
                imageData: {},
                imageIndices: {},
                
                audioData: {},
                audioIndices: {},
                
                loading: false,

                async init() {
                    this.loading = true;
                    
                    // ÂàùÂßãÂåñÂõæÂÉèÂíåÈü≥È¢ëÁöÑÁ¥¢ÂºïÔºàÈªòËÆ§ÊúÄÂêé‰∏Ä‰∏™Ôºâ
                    this.imageTags.forEach(tag => {
                        this.imageIndices[tag] = 0;
                    });
                    this.audioTags.forEach(tag => {
                        this.audioIndices[tag] = 0;
                    });
                    
                    // Âä†ËΩΩÊâÄÊúâÊï∞ÊçÆ
                    await Promise.all([
                        this.loadAllScalars(),
                        this.loadAllImages(),
                        this.loadAllAudio()
                    ]);
                    
                    this.loading = false;
                },

                async loadAllScalars() {
                    for (const tag of this.scalarTags) {
                        try {
                            const response = await fetch(`/api/scalars/${encodeURIComponent(tag)}`);
                            const data = await response.json();
                            this.scalarData[tag] = data;
                        } catch (error) {
                            console.error(`Âä†ËΩΩÊ†áÈáèÊï∞ÊçÆÂ§±Ë¥• [${tag}]:`, error);
                        }
                    }
                    // Ê†áËÆ∞Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê
                    this.scalarsLoaded = true;
                },

                async loadAllImages() {
                    const promises = this.imageTags.map(tag => this.loadImages(tag));
                    await Promise.all(promises);
                },

                async loadImages(tag) {
                    try {
                        const response = await fetch(`/api/images/${encodeURIComponent(tag)}`);
                        const data = await response.json();
                        this.imageData[tag] = data;
                        // ÈªòËÆ§ÊòæÁ§∫ÊúÄÂêé‰∏ÄÂº†
                        this.imageIndices[tag] = data.length - 1;
                    } catch (error) {
                        console.error(`Âä†ËΩΩÂõæÂÉèÊï∞ÊçÆÂ§±Ë¥• [${tag}]:`, error);
                    }
                },

                async loadAllAudio() {
                    const promises = this.audioTags.map(tag => this.loadAudio(tag));
                    await Promise.all(promises);
                },

                async loadAudio(tag) {
                    try {
                        const response = await fetch(`/api/audio/${encodeURIComponent(tag)}`);
                        const data = await response.json();
                        this.audioData[tag] = data;
                        // ÈªòËÆ§ÊòæÁ§∫ÊúÄÂêé‰∏Ä‰∏™
                        this.audioIndices[tag] = data.length - 1;
                    } catch (error) {
                        console.error(`Âä†ËΩΩÈü≥È¢ëÊï∞ÊçÆÂ§±Ë¥• [${tag}]:`, error);
                    }
                }
            }
        }
    </script>
</body>
</html>
